{% extends "base.html" %}

{% block title %}Convonet Sequence Diagram{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <section class="py-12 bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Convonet Sequence Diagram</h1>
                <p class="text-xl text-gray-600 mb-4">Step-by-Step Flow with All Components</p>
                <div class="flex justify-center gap-4">
                    <a href="{{ url_for('convonet_tech_spec') }}" class="text-blue-600 hover:text-blue-800 underline">
                        ← Back to Tech Spec
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Diagram Image -->
            <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Detailed Sequence Diagram</h2>
                <div class="border-2 border-gray-200 rounded-lg overflow-hidden">
                    <img src="{{ url_for('static', filename='assets/img/convonet_s_diagram.png') }}"
                         alt="Convonet Sequence Diagram"
                         class="w-full h-auto">
                </div>
            </div>

            <!-- Phase Overview -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Sequence Phases</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h4 class="font-semibold text-gray-800 mb-1">Phase 1: Authentication</h4>
                        <p class="text-sm text-gray-600">Steps 1-7</p>
                    </div>
                    <div class="border-l-4 border-green-500 pl-4">
                        <h4 class="font-semibold text-gray-800 mb-1">Phase 2: Conversation Loop</h4>
                        <p class="text-sm text-gray-600">Steps 8-31</p>
                    </div>
                    <div class="border-l-4 border-yellow-500 pl-4">
                        <h4 class="font-semibold text-gray-800 mb-1">Phase 3: Transfer Request</h4>
                        <p class="text-sm text-gray-600">Steps 32-38</p>
                    </div>
                    <div class="border-l-4 border-pink-500 pl-4">
                        <h4 class="font-semibold text-gray-800 mb-1">Phase 4: Twilio Transfer</h4>
                        <p class="text-sm text-gray-600">Steps 39-52</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Sequence Steps -->
            <div class="space-y-8">
                <!-- Phase 1: Authentication -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="border-l-4 border-blue-500 pl-4 mb-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Phase 1: Authentication (Steps 1-7)</h3>
                        <p class="text-gray-600">User authentication and session creation</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">1</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">User Browser → WebSocket Server: Connect WebSocket</h4>
                                    <p class="text-sm text-gray-700">User opens the Convonet WebRTC voice assistant UI and establishes a WebSocket connection via Socket.IO to the Flask server.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">2</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebSocket Server → PIN Auth: Request Authentication</h4>
                                    <p class="text-sm text-gray-700">The WebSocket server requests PIN authentication from the authentication module.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">3</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">PIN Auth → PostgreSQL: Validate PIN</h4>
                                    <p class="text-sm text-gray-700">PIN authentication module validates the user's PIN against PostgreSQL database using SQLAlchemy. <strong>Note:</strong> Authentication is handled via PostgreSQL, not FusionPBX.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">4</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">PostgreSQL → PIN Auth: User Data</h4>
                                    <p class="text-sm text-gray-700">PostgreSQL returns user data including user ID, name, and team associations.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">5</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">PIN Auth → Redis: Create Session</h4>
                                    <p class="text-sm text-gray-700">A new session is created in Redis with a unique session ID, storing user context and authentication status.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">6</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">PIN Auth → WebSocket Server: Authenticated</h4>
                                    <p class="text-sm text-gray-700">Authentication module confirms successful authentication to the WebSocket server.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">7</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebSocket Server → User Browser: Session ID</h4>
                                    <p class="text-sm text-gray-700">WebSocket server sends the session ID to the user browser. The user is now authenticated and ready to interact with the voice assistant.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 2: Normal Conversation Loop -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="border-l-4 border-green-500 pl-4 mb-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Phase 2: Normal Conversation Loop (Steps 8-31)</h3>
                        <p class="text-gray-600">Audio capture, transcription, AI processing, and response generation</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">8</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">User Browser → WebSocket Server: Start Recording</h4>
                                    <p class="text-sm text-gray-700">User initiates voice recording in the browser, beginning the audio capture process.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">9</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebSocket Server → WebRTC Voice Server: Audio Chunks (WebRTC)</h4>
                                    <p class="text-sm text-gray-700">Audio chunks are streamed from the browser via WebRTC through the WebSocket server to the WebRTC Voice Server.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">10</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebRTC Voice Server → Redis: Buffer Audio Data</h4>
                                    <p class="text-sm text-gray-700">Each session's audio chunks are appended to a Redis buffer (convonet.redis_manager) so downstream workers can read them for processing.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">11-12</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Redis → Deepgram STT: Send Audio Buffer → Transcribed Text</h4>
                                    <p class="text-sm text-gray-700">The WebRTC worker reads the current buffer and forwards it to Deepgram (not Twilio) for high-fidelity transcription. Deepgram returns the recognized text back to the WebRTC service.</p>
                                    <p class="text-xs text-gray-500 mt-1"><strong>Important:</strong> Deepgram STT is used for WebRTC audio, not Twilio transcription.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">13-15</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebRTC Voice Server → LangGraph → OpenAI LLM: Process Intent</h4>
                                    <p class="text-sm text-gray-700">The transcript enters the LangGraph assistant (Convonet's LangGraph state machine). LangGraph calls OpenAI (LLM) for reasoning and response generation. LLM returns response and tool calls to LangGraph.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">16-21</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Tool Execution (If Needed)</h4>
                                    <p class="text-sm text-gray-700">If the LLM decides to execute an action, LangGraph invokes registered tools:</p>
                                    <ul class="text-sm text-gray-700 list-disc list-inside mt-1 space-y-1">
                                        <li><strong>Database Operations:</strong> PostgreSQL queries/updates via SQLAlchemy</li>
                                        <li><strong>Calendar Operations:</strong> Google Calendar/OAuth workflows</li>
                                        <li><strong>PBX Metadata:</strong> FusionPBX lookups for call metadata</li>
                                    </ul>
                                    <p class="text-sm text-gray-700 mt-2">Tool results are injected back into the LangGraph state, and OpenAI composes the final reply.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">22-24</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">LangGraph → OpenAI LLM → LangGraph: Generate Final Response</h4>
                                    <p class="text-sm text-gray-700">LangGraph sends context to OpenAI LLM for final response generation. LLM returns response text to LangGraph, which passes it to the WebRTC Voice Server.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded border-l-4 border-green-500">
                            <div class="flex items-start">
                                <span class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">25-31</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">OpenAI TTS → Redis → WebSocket → User: Audio Response</h4>
                                    <p class="text-sm text-gray-700">Final text is synthesized via OpenAI TTS (or the configured TTS engine). The audio response is streamed back over Socket.IO to the browser for playback. Audio is buffered in Redis before streaming to ensure smooth playback.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-100 p-3 rounded text-sm text-gray-600 italic">
                            <strong>Loop:</strong> Steps 8-31 repeat for each user utterance, creating a continuous conversation loop until the user requests transfer or ends the session.
                        </div>
                    </div>
                </div>

                <!-- Phase 3: Transfer Request -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="border-l-4 border-yellow-500 pl-4 mb-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Phase 3: Transfer Request (Steps 32-38)</h3>
                        <p class="text-gray-600">User requests transfer and system initiates transfer process</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                            <div class="flex items-start">
                                <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">30</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">User Browser → WebSocket Server: "Transfer to Agent"</h4>
                                    <p class="text-sm text-gray-700">User says "I need a human" or requests transfer to a human agent.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                            <div class="flex items-start">
                                <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">31-32</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebSocket Server → WebRTC Voice Server → LangGraph: Transfer Intent</h4>
                                    <p class="text-sm text-gray-700">Transfer intent is passed through the WebRTC Voice Server to LangGraph for detection and processing.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                            <div class="flex items-start">
                                <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">33-34</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">LangGraph → OpenAI LLM: Detect Transfer Intent → Transfer Command</h4>
                                    <p class="text-sm text-gray-700">LangGraph detects transfer intent and confirms with OpenAI LLM. LLM returns a transfer command to LangGraph.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                            <div class="flex items-start">
                                <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">35</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">LangGraph → Redis: Set Transfer Flag</h4>
                                    <p class="text-sm text-gray-700">LangGraph sets a transfer flag in Redis to indicate that a transfer is in progress.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                            <div class="flex items-start">
                                <span class="bg-yellow-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">36-38</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">LangGraph → WebRTC Voice Server → WebSocket Server → User: Transfer Initiated</h4>
                                    <p class="text-sm text-gray-700">Transfer initiated signal flows back through the system. WebRTC Voice Server sends transfer event to WebSocket Server, which notifies the user browser. User sees transfer status update.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 4: Twilio Transfer Flow -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="border-l-4 border-pink-500 pl-4 mb-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-2">Phase 4: Twilio Transfer Flow (Steps 39-52)</h3>
                        <p class="text-gray-600">Call bridging to FusionPBX and agent dashboard connection</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                            <div class="flex items-start">
                                <span class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">39</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">WebRTC Voice Server → Twilio API: POST /voice_assistant/transfer_bridge</h4>
                                    <p class="text-sm text-gray-700">The WebRTC backend calls the Convonet /twilio/voice_assistant/transfer_bridge endpoint. Twilio uses the provided SIP URI: <code class="bg-gray-100 px-1 rounded">sip:2001@FREEPBX_DOMAIN;transport=udp</code> or trunk number, depending on .env configuration.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                            <div class="flex items-start">
                                <span class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">40</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Twilio → FusionPBX: SIP INVITE to Extension 2001</h4>
                                    <p class="text-sm text-gray-700">Twilio dials FusionPBX (running on Google Cloud) via SIP INVITE. FusionPBX routes the call to the target agent extension (e.g., 2001).</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                            <div class="flex items-start">
                                <span class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">41</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">FusionPBX → Agent Dashboard: Ring Extension 2001</h4>
                                    <p class="text-sm text-gray-700">FusionPBX rings extension 2001. The agent dashboard (JsSIP client) registers with FusionPBX over WSS (wss://&lt;fusionpbx&gt;:7443) and receives the incoming call notification.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                            <div class="flex items-start">
                                <span class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">42-44</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Agent Dashboard → PostgreSQL: Fetch User Info → Show User Info Popup</h4>
                                    <p class="text-sm text-gray-700">Agent dashboard fetches caller record from PostgreSQL via REST API. Dashboard pops the caller record and shows ringing controls with user information (name, context, call history).</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                            <div class="flex items-start">
                                <span class="bg-pink-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">45-48</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Agent Answers → Conversation Begins</h4>
                                    <p class="text-sm text-gray-700">Agent answers the call via JsSIP client. FusionPBX notifies Twilio that the call is connected. Twilio bridges the audio between user leg and agent leg. Live conversation begins between the user and agent.</p>
                                    <p class="text-xs text-gray-500 mt-2"><strong>Note:</strong> Once Twilio bridges the call to FusionPBX, the audio is now a PSTN/SIP leg (not the original WebRTC stream). Deepgram STT may still be used on the server side for context logging if needed.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 p-4 rounded border-l-4 border-red-500">
                            <div class="flex items-start">
                                <span class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">49-52</span>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Alternative: Agent Rejects/Timeout</h4>
                                    <p class="text-sm text-gray-700">If the agent rejects the call or it times out:</p>
                                    <ul class="text-sm text-gray-700 list-disc list-inside mt-1 space-y-1">
                                        <li>FusionPBX notifies Twilio that the call failed</li>
                                        <li>Twilio sends transfer failed notification to WebRTC Voice Server</li>
                                        <li>WebRTC Voice Server sends transfer error event to WebSocket Server</li>
                                        <li>User browser displays transfer failed message</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-100 p-3 rounded text-sm text-gray-600 italic">
                            <strong>Transfer Callback:</strong> Convonet logs the transfer outcome via the /transfer_callback webhook for monitoring and Sentry alerts.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Points Summary -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg shadow-md mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Key Sequence Points</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded">
                        <h4 class="font-semibold text-gray-800 mb-2">Authentication Path</h4>
                        <p class="text-sm text-gray-700">PIN authentication uses PostgreSQL (not FusionPBX). Sessions are stored in Redis for fast access.</p>
                    </div>
                    <div class="bg-white p-4 rounded">
                        <h4 class="font-semibold text-gray-800 mb-2">Audio Processing</h4>
                        <p class="text-sm text-gray-700">Deepgram STT is used for WebRTC audio transcription, not Twilio. Redis buffers audio chunks for processing.</p>
                    </div>
                    <div class="bg-white p-4 rounded">
                        <h4 class="font-semibold text-gray-800 mb-2">AI Orchestration</h4>
                        <p class="text-sm text-gray-700">LangGraph coordinates between OpenAI LLM and MCP tools. Tool execution happens before final response generation.</p>
                    </div>
                    <div class="bg-white p-4 rounded">
                        <h4 class="font-semibold text-gray-800 mb-2">Transfer Mechanism</h4>
                        <p class="text-sm text-gray-700">Twilio bridges the WebRTC user leg to the SIP agent leg. Audio transitions from WebRTC to PSTN/SIP stream.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

