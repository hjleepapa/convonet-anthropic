<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Center - Agent Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('call_center.static', filename='css/call_center.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="login-box">
                <div class="logo">
                    <i class="fas fa-headset"></i>
                    <h1>Call Center Agent</h1>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="agentId">Agent ID</label>
                        <input type="text" id="agentId" name="agent_id" required placeholder="Enter your agent ID">
                    </div>
                    <div class="form-group">
                        <label for="agentName">Name</label>
                        <input type="text" id="agentName" name="name" required placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label for="sipUsername">SIP Username</label>
                        <input type="text" id="sipUsername" name="sip_username" required placeholder="SIP username">
                    </div>
                    <div class="form-group">
                        <label for="sipPassword">SIP Password</label>
                        <input type="password" id="sipPassword" name="sip_password" required placeholder="SIP password">
                    </div>
                    <div class="form-group">
                        <label for="sipDomain">SIP Domain</label>
                        <input type="text" id="sipDomain" name="sip_domain" value="sip.example.com" required placeholder="SIP server domain">
                    </div>
                    <div class="form-group">
                        <label for="sipExtension">Extension</label>
                        <input type="text" id="sipExtension" name="sip_extension" placeholder="Extension number">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
            </div>
        </div>

        <!-- Agent Dashboard -->
        <div id="dashboardScreen" class="screen">
            <header class="dashboard-header">
                <div class="header-left">
                    <i class="fas fa-headset"></i>
                    <h2>Agent Dashboard</h2>
                </div>
                <div class="header-center">
                    <div class="agent-info">
                        <span class="agent-name" id="agentNameDisplay"></span>
                        <span class="agent-extension" id="agentExtension"></span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="sip-status" id="sipStatus">
                        <i class="fas fa-circle"></i>
                        <span>Disconnected</span>
                    </div>
                    <button id="logoutBtn" class="btn btn-sm btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Agent Status Panel -->
                <div class="panel agent-status-panel">
                    <h3>Agent Status</h3>
                    <div class="status-controls">
                        <button id="readyBtn" class="btn btn-success status-btn" disabled>
                            <i class="fas fa-check-circle"></i>
                            <span>Ready</span>
                        </button>
                        <button id="notReadyBtn" class="btn btn-warning status-btn" disabled>
                            <i class="fas fa-pause-circle"></i>
                            <span>Not Ready</span>
                        </button>
                    </div>
                    <div class="current-status">
                        <label>Current Status:</label>
                        <span id="currentStatus" class="status-badge logged-out">Logged Out</span>
                    </div>
                    <div class="status-timer">
                        <label>Time in Status:</label>
                        <span id="statusTimer">00:00:00</span>
                    </div>
                </div>

                <!-- Call Control Panel -->
                <div class="panel call-control-panel">
                    <h3>Call Controls</h3>
                    <div class="call-info" id="callInfo">
                        <div class="no-call">
                            <i class="fas fa-phone-slash"></i>
                            <p>No active call</p>
                        </div>
                    </div>
                    <div class="call-buttons" id="callButtons">
                        <button id="answerBtn" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-phone"></i> Answer
                        </button>
                        <button id="holdBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-pause"></i> Hold
                        </button>
                        <button id="unholdBtn" class="btn btn-secondary" disabled style="display:none;">
                            <i class="fas fa-play"></i> Unhold
                        </button>
                        <button id="transferBtn" class="btn btn-info" disabled>
                            <i class="fas fa-exchange-alt"></i> Transfer
                        </button>
                        <button id="hangupBtn" class="btn btn-danger btn-lg" disabled>
                            <i class="fas fa-phone-slash"></i> Hangup
                        </button>
                    </div>
                    <div id="transferPanel" class="transfer-panel" style="display:none;">
                        <h4>Transfer Call</h4>
                        <div class="form-group">
                            <input type="text" id="transferNumber" placeholder="Enter extension or number">
                        </div>
                        <div class="transfer-buttons">
                            <button id="blindTransferBtn" class="btn btn-primary">
                                <i class="fas fa-share"></i> Blind Transfer
                            </button>
                            <button id="attendedTransferBtn" class="btn btn-primary">
                                <i class="fas fa-users"></i> Attended Transfer
                            </button>
                            <button id="cancelTransferBtn" class="btn btn-secondary">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dialpad Panel -->
                <div class="panel dialpad-panel">
                    <h3>Dialpad</h3>
                    <div class="dial-display">
                        <input type="text" id="dialInput" placeholder="Enter number" readonly>
                    </div>
                    <div class="dialpad">
                        <button class="dial-btn" data-digit="1">1</button>
                        <button class="dial-btn" data-digit="2">2<span>ABC</span></button>
                        <button class="dial-btn" data-digit="3">3<span>DEF</span></button>
                        <button class="dial-btn" data-digit="4">4<span>GHI</span></button>
                        <button class="dial-btn" data-digit="5">5<span>JKL</span></button>
                        <button class="dial-btn" data-digit="6">6<span>MNO</span></button>
                        <button class="dial-btn" data-digit="7">7<span>PQRS</span></button>
                        <button class="dial-btn" data-digit="8">8<span>TUV</span></button>
                        <button class="dial-btn" data-digit="9">9<span>WXYZ</span></button>
                        <button class="dial-btn" data-digit="*">*</button>
                        <button class="dial-btn" data-digit="0">0<span>+</span></button>
                        <button class="dial-btn" data-digit="#">#</button>
                    </div>
                    <div class="dial-actions">
                        <button id="dialCallBtn" class="btn btn-success btn-block" disabled>
                            <i class="fas fa-phone"></i> Call
                        </button>
                        <button id="dialClearBtn" class="btn btn-secondary btn-block">
                            <i class="fas fa-backspace"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Call History Panel -->
                <div class="panel call-history-panel">
                    <h3>Recent Calls</h3>
                    <div id="callHistory" class="call-history">
                        <p class="no-history">No recent calls</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Popup Modal -->
    <div id="customerPopup" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-user"></i> 
                    Customer Information
                </h3>
                <span class="close-modal" id="closeCustomerPopup">&times;</span>
            </div>
            <div class="modal-body" id="customerData">
                <div class="customer-info loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading customer data...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="acceptCallFromPopup">
                    <i class="fas fa-phone"></i> Accept Call
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="ringTone" loop>
        <source src="{{ url_for('call_center.static', filename='audio/ringtone.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="remoteAudio"></audio>

    <!-- Scripts -->
    <!-- Load JsSIP library (locally hosted, v3.10.1) -->
    <script src="{{ url_for('call_center.static', filename='js/jssip.min.js') }}"></script>
    <script>
        // SIP Configuration from server
        window.SIP_CONFIG = {
            domain: '{{ sip_config.domain }}',
            wss_port: {{ sip_config.wss_port }}
        };
        
        // Verify JsSIP loaded correctly
        window.addEventListener('load', function() {
            if (typeof JsSIP !== 'undefined') {
                console.log('✓ JsSIP v3.10.1 loaded successfully');
                console.log('SIP Config:', window.SIP_CONFIG);
                // Make it available as SIP for compatibility
                window.SIP = window.JsSIP;
            } else {
                console.error('❌ JsSIP library failed to load!');
                alert('Error: SIP library not loaded. Please refresh the page or contact support.');
            }
        });
    </script>
    <script src="{{ url_for('call_center.static', filename='js/call_center.js') }}"></script>
</body>
</html>

