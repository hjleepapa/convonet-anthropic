{% extends "base.html" %}

{% block title %}Convonet System Architecture Diagram{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <section class="py-12 bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Convonet System Architecture Diagram</h1>
                <p class="text-xl text-gray-600 mb-4">Complete System Flow Overview</p>
                <div class="flex justify-center gap-4">
                    <a href="{{ url_for('convonet_tech_spec') }}" class="text-blue-600 hover:text-blue-800 underline">
                        ← Back to Tech Spec
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Diagram Image -->
            <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Complete System Architecture</h2>
                <div class="border-2 border-gray-200 rounded-lg overflow-hidden">
                    <img src="/convonet_todo/static/assets/img/convonet_flow_diagram.png" 
                         alt="Convonet System Architecture Flow Diagram" 
                         class="w-full h-auto">
                </div>
            </div>

            <!-- Color Legend -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Color-Coded Components</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h4 class="font-semibold text-gray-800">User Components</h4>
                        <p class="text-sm text-gray-600">Browser-based interfaces</p>
                    </div>
                    <div class="border-l-4 border-purple-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Server Components</h4>
                        <p class="text-sm text-gray-600">Flask/WebSocket services</p>
                    </div>
                    <div class="border-l-4 border-green-500 pl-4">
                        <h4 class="font-semibold text-gray-800">AI/ML Components</h4>
                        <p class="text-sm text-gray-600">LangGraph, OpenAI, Deepgram</p>
                    </div>
                    <div class="border-l-4 border-orange-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Tools/APIs</h4>
                        <p class="text-sm text-gray-600">MCP tools, PostgreSQL, Google APIs</p>
                    </div>
                    <div class="border-l-4 border-pink-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Transfer System</h4>
                        <p class="text-sm text-gray-600">Twilio, FusionPBX</p>
                    </div>
                    <div class="border-l-4 border-yellow-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Agent Dashboard</h4>
                        <p class="text-sm text-gray-600">JsSIP client</p>
                    </div>
                    <div class="border-l-4 border-red-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Monitoring</h4>
                        <p class="text-sm text-gray-600">Sentry, Logs</p>
                    </div>
                    <div class="border-l-4 border-teal-500 pl-4">
                        <h4 class="font-semibold text-gray-800">Storage</h4>
                        <p class="text-sm text-gray-600">Redis, PostgreSQL</p>
                    </div>
                </div>
            </div>

            <!-- Component Descriptions -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">System Components</h3>
                
                <div class="space-y-6">
                    <!-- User Browser -->
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">User Browser (Voice Assistant UI)</h4>
                        <p class="text-gray-700 mb-2">Browser-based WebRTC voice interface where users interact with the AI assistant. Captures audio from the user's microphone and plays back AI responses.</p>
                        <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                            <li>WebRTC audio capture and playback</li>
                            <li>Real-time Socket.IO connection</li>
                            <li>PIN authentication interface</li>
                        </ul>
                    </div>

                    <!-- Flask/WebSocket Server -->
                    <div class="border-l-4 border-purple-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Flask/WebSocket Server</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">WebSocket Server (Socket.IO)</h5>
                                <p class="text-gray-700 mb-2">Manages real-time bidirectional communication between the browser and server. Handles WebSocket connections, message routing, and event broadcasting.</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">PIN Authentication Module</h5>
                                <p class="text-gray-700 mb-2">Validates user PIN credentials against PostgreSQL database. Creates authenticated sessions stored in Redis.</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">WebRTC Voice Server</h5>
                                <p class="text-gray-700 mb-2">Processes audio streams from the browser, manages transcription pipeline, and coordinates with LangGraph for AI responses. Located in <code class="bg-gray-100 px-1 rounded">convonet/webrtc_voice_server.py</code>.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Session Management -->
                    <div class="border-l-4 border-teal-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Redis (Audio Buffer & Session Management)</h4>
                        <p class="text-gray-700 mb-2">In-memory data store for session management and audio buffering. Stores authenticated sessions, audio chunks, and conversation state.</p>
                        <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                            <li>Audio buffer management for WebRTC streams</li>
                            <li>Session storage and authentication tokens</li>
                            <li>Real-time Pub/Sub notifications</li>
                            <li>Transfer flags and state management</li>
                        </ul>
                    </div>

                    <!-- Speech Processing -->
                    <div class="border-l-4 border-green-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Speech Processing</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Deepgram STT (Speech-to-Text)</h5>
                                <p class="text-gray-700 mb-2">Converts audio streams to text with high accuracy. Processes WebRTC audio buffers from Redis and returns transcribed text for LangGraph processing.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>Real-time audio transcription</li>
                                    <li>WebM format support</li>
                                    <li>High accuracy (95%+)</li>
                                    <li>Low latency (200-500ms)</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">OpenAI TTS (Text-to-Speech)</h5>
                                <p class="text-gray-700 mb-2">Converts AI-generated text responses into natural-sounding speech audio. Returns audio streams for browser playback.</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Orchestration -->
                    <div class="border-l-4 border-green-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">AI Orchestration</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">LangGraph (Assistant Graph)</h5>
                                <p class="text-gray-700 mb-2">Orchestrates the AI conversation flow. Manages state transitions, tool execution decisions, and coordinates between LLM calls and external tools.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>State machine for conversation management</li>
                                    <li>Tool condition evaluation</li>
                                    <li>Transfer intent detection</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">OpenAI LLM (GPT-4/Claude)</h5>
                                <p class="text-gray-700 mb-2">Generates intelligent responses based on user input and conversation context. Decides when tool execution is needed and produces final responses.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tools & External APIs -->
                    <div class="border-l-4 border-orange-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Tools & External APIs</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Tool Calling (MCP Tools)</h5>
                                <p class="text-gray-700 mb-2">Model Context Protocol (MCP) tools for external operations. 38 total tools including database operations, calendar integration, and call transfer.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>36 database tools (todos, teams, users)</li>
                                    <li>2 transfer tools (call transfer to agent)</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">PostgreSQL Database</h5>
                                <p class="text-gray-700 mb-2">Multi-tenant relational database storing todos, teams, users, and conversation history.</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Google APIs (Calendar/OAuth)</h5>
                                <p class="text-gray-700 mb-2">Calendar integration with OAuth2 authentication for scheduling and event management.</p>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">FusionPBX Metadata Lookup</h5>
                                <p class="text-gray-700 mb-2">Retrieves extension information and call routing metadata from FusionPBX.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer System -->
                    <div class="border-l-4 border-pink-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Transfer System</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Twilio API (Programmable Voice)</h5>
                                <p class="text-gray-700 mb-2">Handles call transfer bridging between WebRTC user and FusionPBX agent. Provides SIP trunking and audio bridging capabilities.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>SIP INVITE to FusionPBX</li>
                                    <li>Audio bridge between user and agent</li>
                                    <li>Transfer status callbacks</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">FusionPBX (Google Cloud)</h5>
                                <p class="text-gray-700 mb-2">Private Branch Exchange (PBX) system running on Google Cloud VM. Routes calls to extension 2001 (agent dashboard).</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>SIP server for call routing</li>
                                    <li>Extension 2001 for agent calls</li>
                                    <li>WSS support on port 7443</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Dashboard -->
                    <div class="border-l-4 border-yellow-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Agent Dashboard</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Call-Center Agent Dashboard (JsSIP Client)</h5>
                                <p class="text-gray-700 mb-2">Browser-based softphone using JsSIP v3.10.1. Registers with FusionPBX over WebSocket Secure (WSS) and handles incoming calls from transferred users.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>JsSIP WebRTC client</li>
                                    <li>SIP registration with FusionPBX</li>
                                    <li>Incoming call handling</li>
                                    <li>Call controls (answer, hold, transfer, hangup)</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">User Info Popup (Call Controls)</h5>
                                <p class="text-gray-700 mb-2">Displays caller information retrieved from PostgreSQL. Shows user details, call context, and provides call control interface.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoring -->
                    <div class="border-l-4 border-red-500 pl-4">
                        <h4 class="font-semibold text-lg text-gray-800 mb-2">Monitoring</h4>
                        <div class="space-y-4">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Sentry (Error Monitoring)</h5>
                                <p class="text-gray-700 mb-2">Production-grade error tracking and performance monitoring. Tracks all operations across the system with real-time alerts.</p>
                                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                                    <li>Error tracking and alerting</li>
                                    <li>Performance monitoring (agent processing time)</li>
                                    <li>User context and session tracking</li>
                                    <li>Timeout and thread reset tracking</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-1">Application Logs</h5>
                                <p class="text-gray-700 mb-2">Comprehensive logging for debugging and audit trails. Logs all system operations, API calls, and state transitions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Flow Summary -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Data Flow Summary</h3>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded border-l-4 border-green-500">
                        <h4 class="font-semibold text-gray-800 mb-2">WebRTC Flow (Normal Conversation)</h4>
                        <p class="text-sm text-gray-700">
                            <strong>User Browser</strong> → <strong>PIN Auth (PostgreSQL)</strong> → <strong>Redis Audio Buffer</strong> → 
                            <strong>Deepgram STT</strong> → <strong>LangGraph</strong> → <strong>OpenAI LLM</strong> → 
                            <strong>Tool Calling</strong> → <strong>PostgreSQL/Google APIs</strong> → <strong>OpenAI TTS</strong> → <strong>User Browser</strong>
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded border-l-4 border-pink-500">
                        <h4 class="font-semibold text-gray-800 mb-2">Transfer Flow</h4>
                        <p class="text-sm text-gray-700">
                            <strong>User Request</strong> → <strong>LangGraph (Detect Intent)</strong> → <strong>Twilio API</strong> → 
                            <strong>FusionPBX (Extension 2001)</strong> → <strong>Agent Dashboard (JsSIP)</strong> → 
                            <strong>User Info Popup</strong> → <strong>Live Conversation</strong>
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded border-l-4 border-red-500">
                        <h4 class="font-semibold text-gray-800 mb-2">Monitoring</h4>
                        <p class="text-sm text-gray-700">
                            <strong>All Operations</strong> → <strong>Sentry Monitoring</strong> → <strong>Real-time Alerts & Performance Tracking</strong>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Architecture Summary -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Architecture Overview</h3>
                <p class="text-gray-700 leading-relaxed">
                    The Convonet System Architecture represents an enterprise-grade voice AI platform with comprehensive 
                    integration of multiple technologies. The system starts with user authentication via PIN validation 
                    against PostgreSQL, then processes real-time audio through WebRTC to Deepgram STT for transcription.
                    <br><br>
                    LangGraph orchestrates the AI conversation flow, coordinating with OpenAI LLM for intelligent responses 
                    and MCP tools for external operations. The system includes 38 tools for database operations, calendar 
                    integration, and call transfer capabilities.
                    <br><br>
                    When a user requests transfer to a human agent, LangGraph detects the intent and initiates a Twilio 
                    API call to bridge the WebRTC user with a FusionPBX extension. The agent dashboard (JsSIP client) 
                    receives the call, displays user information, and enables live conversation.
                    <br><br>
                    Throughout the system, Sentry provides comprehensive error monitoring and performance tracking, while 
                    Redis manages session state and audio buffering. All operations are optimized with timeout handling 
                    (8s/10s/12s) to ensure Twilio compatibility and reliable performance.
                </p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

